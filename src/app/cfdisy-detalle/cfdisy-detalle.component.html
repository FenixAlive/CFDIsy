<div class="cfdi-detail-container" *ngIf="xml">
  <button class="floating-close-btn" (click)="close()" title="Cerrar">
    &times;
  </button>
  <!-- Valid Code / Status -->
  <div class="status-banner {{ xml['Status'] }}" *ngIf="xml['Valid'] || xml['Status']">
    {{ xml['Valid'] ? 'Estado: ' + xml['Valid'] : 'CFDI pendiente de validación o sin respuesta del SAT.' }}
  </div>

  <!-- Header Info -->
  <header class="cfdi-header">
    <div class="header-main">
      <div class="field-item">
        <span class="label">Serie:</span>
        <span class="value">{{ xml?.Serie ?? '--' }}</span>
      </div>
      <div class="field-item">
        <span class="label">Folio:</span>
        <span class="value">{{ xml?.Folio ?? '--' }}</span>
      </div>
      <div class="field-item uuid">
        <span class="label">UUID:</span>
        <span class="value">{{ xml?.Complemento?.TimbreFiscalDigital?.UUID ?? '--' }}</span>
      </div>
    </div>
    <div class="header-details">
      <div class="field-item">
        <span class="label">Versión CFDI:</span>
        <span class="value">{{ xml?.Version ?? '4.0' }}</span>
      </div>
      <div class="field-item" *ngIf="xml?.Moneda">
        <span class="label">Moneda:</span>
        <span class="value">{{ xml.Moneda }}</span>
      </div>
      <div class="field-item" *ngIf="xml?.FormaPago">
        <span class="label">Forma de Pago:</span>
        <span class="value">{{ xml.FormaPago }} <small *ngIf="formaPagoMap[xml.FormaPago]">({{
            formaPagoMap[xml.FormaPago]
            }})</small></span>
      </div>
      <div class="field-item" *ngIf="xml?.MetodoPago">
        <span class="label">Método de Pago:</span>
        <span class="value">{{ xml.MetodoPago }} <small *ngIf="metodoPagoMap[xml.MetodoPago]">({{
            metodoPagoMap[xml.MetodoPago]
            }})</small></span>
      </div>
      <div class="field-item" *ngIf="xml?.Exportacion">
        <span class="label">Exportación:</span>
        <span class="value">{{ xml.Exportacion }} <small *ngIf="exportacionMap[xml.Exportacion]">({{
            exportacionMap[xml.Exportacion] }})</small></span>
      </div>
      <div class="field-item">
        <span class="label">Fecha Emisión:</span>
        <span class="value">{{ xml?.Fecha | date:'medium' }}</span>
      </div>
      <div class="field-item">
        <span class="label">Tipo de Comprobante:</span>
        <span class="value">{{ xml?.TipoDeComprobante }} <small *ngIf="tipoComprobanteMap[xml.TipoDeComprobante]">({{
            tipoComprobanteMap[xml.TipoDeComprobante] }})</small></span>
      </div>
      <div class="field-item">
        <span class="label">Lugar de Expedición:</span>
        <span class="value">{{ xml?.LugarExpedicion }}</span>
      </div>
    </div>
  </header>

  <!-- Global Info (CFDI 4.0) -->
  <section class="global-info" *ngIf="xml?.InformacionGlobal">
    <h3 class="section-title">Información Global</h3>
    <div class="grid-3">
      <div class="field-item">
        <span class="label">Periodicidad:</span>
        <span class="value">{{ xml.InformacionGlobal.Periodicidad }} <small
            *ngIf="periodicidadMap[xml.InformacionGlobal.Periodicidad]">({{
            periodicidadMap[xml.InformacionGlobal.Periodicidad] }})</small></span>
      </div>
      <div class="field-item">
        <span class="label">Meses:</span>
        <span class="value">{{ xml.InformacionGlobal.Meses }} <small *ngIf="mesesMap[xml.InformacionGlobal.Meses]">({{
            mesesMap[xml.InformacionGlobal.Meses] }})</small></span>
      </div>
      <div class="field-item">
        <span class="label">Año:</span>
        <span class="value">{{ xml.InformacionGlobal['Año'] }}</span>
      </div>
    </div>
  </section>

  <!-- Related Documents -->
  <section class="related-docs" *ngFor="let relGroup of cfdiRelacionados">
    <h3 class="section-title">Documentos Relacionados (Tipo: {{ relGroup.TipoRelacion }})</h3>
    <ul class="uuid-list">
      <li *ngFor="let rel of getRelatedUUIDs(relGroup)">
        {{ $any(rel).UUID }}
      </li>
    </ul>
  </section>

  <!-- Emisor & Receptor -->
  <div class="parties-container">
    <div class="party-card emisor">
      <h3 class="party-title">Emisor</h3>
      <div class="party-content">
        <div class="party-name">{{ xml?.Emisor?.Nombre }}</div>
        <div class="party-rfc">RFC: {{ xml?.Emisor?.Rfc }}</div>
        <div class="field-item" *ngIf="xml?.Emisor?.RegimenFiscal">
          <span class="label">Régimen Fiscal:</span>
          <span class="value">{{ xml.Emisor.RegimenFiscal }} <small
              *ngIf="regimenFiscalMap[xml.Emisor.RegimenFiscal]">({{
              regimenFiscalMap[xml.Emisor.RegimenFiscal] }})</small></span>
        </div>
      </div>
    </div>

    <div class="party-card receptor">
      <h3 class="party-title">Receptor</h3>
      <div class="party-content">
        <div class="party-name">{{ xml?.Receptor?.Nombre }}</div>
        <div class="party-rfc">RFC: {{ xml?.Receptor?.Rfc }}</div>
        <div class="field-item" *ngIf="xml?.Receptor?.UsoCFDI">
          <span class="label">Uso CFDI:</span>
          <span class="value">{{ xml.Receptor.UsoCFDI }} <small *ngIf="usoCfdiMap[xml.Receptor.UsoCFDI]">({{
              usoCfdiMap[xml.Receptor.UsoCFDI] }})</small></span>
        </div>
        <div class="field-item" *ngIf="xml?.Receptor?.RegimenFiscalReceptor">
          <span class="label">Régimen Fiscal Receptor:</span>
          <span class="value">{{ xml.Receptor.RegimenFiscalReceptor }} <small
              *ngIf="regimenFiscalMap[xml.Receptor.RegimenFiscalReceptor]">({{
              regimenFiscalMap[xml.Receptor.RegimenFiscalReceptor] }})</small></span>
        </div>
        <div class="field-item" *ngIf="xml?.Receptor?.DomicilioFiscalReceptor">
          <span class="label">CP Receptor:</span>
          <span class="value">{{ xml.Receptor.DomicilioFiscalReceptor }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Conceptos -->
  <section class="conceptos-section">
    <h3 class="section-title">Conceptos</h3>
    <div class="concepts-wrapper">
      <table class="conceptos-table">
        <thead>
          <tr>
            <th>Cant.</th>
            <th>Unidad</th>
            <th>Clave P/S</th>
            <th>Descripción</th>
            <th>Valor Unit.</th>
            <th>Importe</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let concepto of conceptos">
            <tr class="main-row">
              <td data-label="Cant.">{{ concepto.Cantidad }}</td>
              <td data-label="Unidad">{{ concepto.ClaveUnidad }} <small *ngIf="concepto.Unidad">({{ concepto.Unidad
                  }})</small></td>
              <td data-label="Clave P/S">{{ concepto.ClaveProdServ }} <small
                  *ngIf="claveProdServMap[concepto.ClaveProdServ]">({{
                  claveProdServMap[concepto.ClaveProdServ] }})</small></td>
              <td data-label="Descripción">{{ concepto.Descripcion }}</td>
              <td data-label="Valor Unit.">{{ concepto.ValorUnitario | currency }}</td>
              <td data-label="Importe">{{ concepto.Importe | currency }}</td>
            </tr>
            <!-- Sub-details for Concepto -->
            <tr class="details-row">
              <td colspan="6">
                <div class="concept-details">
                  <span *ngIf="concepto.NoIdentificacion"><strong>No. Identificación:</strong> {{
                    concepto.NoIdentificacion }} | </span>
                  <span *ngIf="xml.Descuento"><strong>Descuento:</strong> {{ concepto.Descuento | currency }} |
                  </span>
                  <span *ngIf="concepto.ObjetoImp"><strong>Objeto Impuesto:</strong> {{ concepto.ObjetoImp }} <small
                      *ngIf="objetoImpuestoMap[concepto.ObjetoImp]">({{
                      objetoImpuestoMap[concepto.ObjetoImp] }})</small></span>

                  <!-- Taxes per concept -->
                  <div class="concept-taxes"
                    *ngIf="getImpuestosConcepto(concepto).traslados.length || getImpuestosConcepto(concepto).retenciones.length">
                    <div class="label">Impuestos del concepto:</div>
                    <div class="tax-tag tras" *ngFor="let t of getImpuestosConcepto(concepto).traslados">
                      Traslado: {{ impuestoMap[t.Impuesto] ?? t.Impuesto }} | Base: {{ t.Base | currency }} | {{
                      t.TipoFactor }}: {{ t.TasaOCuota }}
                      | {{ t.Importe | currency }}
                    </div>
                    <div class="tax-tag ret" *ngFor="let r of getImpuestosConcepto(concepto).retenciones">
                      Retención: {{ impuestoMap[r.Impuesto] ?? r.Impuesto }} | Base: {{ r.Base | currency }} | {{
                      r.TipoFactor }}: {{ r.TasaOCuota }}
                      | {{ r.Importe | currency }}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Complemento de Pago (Pagos 2.0) -->
  <section class="pagos-section" *ngIf="xml?.Complemento?.Pagos">
    <h3 class="section-title">Complemento de Recepción de Pagos</h3>
    <div class="pago-item card" *ngFor="let pago of pagos">
      <div class="pago-header">
        <div class="grid-4">
          <div class="field-item"><span class="label">Fecha Pago:</span><span class="value">{{ pago.FechaPago }}</span>
          </div>
          <div class="field-item"><span class="label">Forma Pago:</span><span class="value">{{ pago.FormaDePagoP
              }}</span></div>
          <div class="field-item"><span class="label">Moneda:</span><span class="value">{{ pago.MonedaP }}</span></div>
          <div class="field-item"><span class="label">Monto:</span><span class="value">{{ pago.Monto | currency
              }}</span></div>
        </div>
      </div>

      <!-- Doctos Relacionados in Pago -->
      <div class="doctos-relacionados" *ngIf="getDocsRelacionados(pago).length">
        <div class="sub-title">Documentos Pagados</div>
        <table class="nested-table">
          <thead>
            <tr>
              <th>Id Documento (UUID)</th>
              <th>Parc.</th>
              <th>Imp. Saldo Ant.</th>
              <th>Imp. Pagado</th>
              <th>Imp. Saldo Insoluto</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doc of getDocsRelacionados(pago)">
              <td>{{ doc.IdDocumento }}</td>
              <td>{{ doc.NumParcialidad }}</td>
              <td>{{ doc.ImpSaldoAnt | currency }}</td>
              <td>{{ doc.ImpPagado | currency }}</td>
              <td>{{ doc.ImpSaldoInsoluto | currency }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Totals & Taxes Summary -->
  <footer class="cfdi-footer">
    <div class="summary-container">
      <div class="tax-summary" *ngIf="xml?.Impuestos">
        <div class="summary-title">Resumen de Impuestos</div>
        <div class="field-item" *ngIf="xml.Impuestos.TotalImpuestosTrasladados">
          <span class="label">Total Trasladados:</span>
          <span class="value">{{ xml.Impuestos.TotalImpuestosTrasladados | currency }}</span>
        </div>
        <div class="field-item" *ngIf="xml.Impuestos.TotalImpuestosRetenidos">
          <span class="label">Total Retenidos:</span>
          <span class="value">{{ xml.Impuestos.TotalImpuestosRetenidos | currency }}</span>
        </div>
        <!-- Detailed Tax Footer -->
        <ng-container *ngIf="xml.Impuestos.Traslados">
          <div class="field-item small-tax" *ngFor="let t of toArray(xml.Impuestos.Traslados.Traslado)">
            <span class="label">{{ impuestoMap[t.Impuesto] ?? 'Traslado ' + t.Impuesto }} <span *ngIf="t.TasaOCuota">({{
                t.TasaOCuota }})</span>:</span>
            <span class="value">{{ t.Importe | currency }}</span>
          </div>
        </ng-container>
        <ng-container *ngIf="xml.Impuestos.Retenciones">
          <div class="field-item small-tax" *ngFor="let r of toArray(xml.Impuestos.Retenciones.Retencion)">
            <span class="label">{{ impuestoMap[r.Impuesto] ?? 'Retención ' + r.Impuesto }} <span
                *ngIf="r.TasaOCuota">({{ r.TasaOCuota }})</span>:</span>
            <span class="value">{{ r.Importe | currency }}</span>
          </div>
        </ng-container>
      </div>

      <div class="totals-summary">
        <div class="field-item">
          <span class="label">Subtotal:</span>
          <span class="value">{{ xml?.SubTotal | currency }}</span>
        </div>
        <div class="field-item" *ngIf="xml?.Descuento">
          <span class="label">Descuento:</span>
          <span class="value">- {{ xml.Descuento | currency }}</span>
        </div>
        <div class="field-item highlight">
          <span class="label">TOTAL:</span>
          <span class="value">{{ xml?.Total | currency }}</span>
        </div>
        <div class="field-item pesos" *ngIf="xml?.TipoCambio && xml?.TipoCambio != 1">
          <span class="label">Total en MXN (T.C. {{ xml.TipoCambio }}):</span>
          <span class="value">{{ totalPesos | currency }}</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Certificación & Stamps -->
  <section class="stamps-section">
    <div class="stamps-grid">
      <div class="qr-container">
        <!-- Assuming we might add QR generation here in the future or keep a placeholder -->
        <small>QR SAT</small>
      </div>
      <div class="stamp-details">
        <div class="field-item small">
          <span class="label">No. Certificado Emisor:</span>
          <span class="value">{{ xml?.NoCertificado }}</span>
        </div>
        <div class="field-item small">
          <span class="label">Folio Fiscal (UUID):</span>
          <span class="value">{{ xml?.Complemento?.TimbreFiscalDigital?.UUID }}</span>
        </div>
        <div class="field-item small">
          <span class="label">Sello Digital del Emisor:</span>
          <div class="stamp-box">{{ xml?.Sello }}</div>
        </div>
        <div class="field-item small">
          <span class="label">Sello del SAT:</span>
          <div class="stamp-box">{{ xml?.Complemento?.TimbreFiscalDigital?.SelloSAT }}</div>
        </div>
        <div class="field-item small" *ngIf="xml?.Complemento?.TimbreFiscalDigital">
          <span class="label">Cadena Original del Complemento de Certificación Digital del SAT:</span>
          <div class="stamp-box">
            ||{{xml['Complemento']['TimbreFiscalDigital']['Version']}}|{{xml['Complemento']['TimbreFiscalDigital']['UUID']}}|{{xml['Complemento']['TimbreFiscalDigital']['FechaTimbrado']}}|{{xml['Complemento']['TimbreFiscalDigital']['RfcProvCertif']}}|{{xml['Sello']}}||
          </div>
        </div>
      </div>
    </div>
  </section>
</div>