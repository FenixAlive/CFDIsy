<div class="cfdi-detail-container" *ngIf="xml">
  <!-- Valid Code / Status -->
  <div class="status-banner {{ xml['Status'] }}" *ngIf="xml['Valid'] || xml['Status']">
    {{ xml['Valid'] || 'CFDI pendiente de validación o sin respuesta del SAT.' }}
  </div>

  <!-- Header Info -->
  <header class="cfdi-header">
    <div class="header-main">
      <div class="field-item">
        <span class="label">Serie/Folio:</span>
        <span class="value">{{ xml?.Serie ?? '' }}{{ xml?.Folio ?? '--' }}</span>
      </div>
      <div class="field-item uuid">
        <span class="label">UUID:</span>
        <span class="value">{{ xml?.Complemento?.TimbreFiscalDigital?.UUID ?? '--' }}</span>
      </div>
    </div>
    <div class="header-details">
      <div class="field-item">
        <span class="label">Versión CFDI:</span>
        <span class="value">{{ xml?.Version ?? '4.0' }}</span>
      </div>
      <div class="field-item">
        <span class="label">Fecha Emisión:</span>
        <span class="value">{{ xml?.Fecha | date:'medium' }}</span>
      </div>
      <div class="field-item">
        <span class="label">Tipo de Comprobante:</span>
        <span class="value">{{ xml?.TipoDeComprobante }}</span>
      </div>
      <div class="field-item">
        <span class="label">Lugar de Expedición:</span>
        <span class="value">{{ xml?.LugarExpedicion }}</span>
      </div>
    </div>
  </header>

  <!-- Global Info (CFDI 4.0) -->
  <section class="global-info" *ngIf="xml?.InformacionGlobal">
    <h3 class="section-title">Información Global</h3>
    <div class="grid-3">
      <div class="field-item">
        <span class="label">Periodicidad:</span>
        <span class="value">{{ xml.InformacionGlobal.Periodicidad }}</span>
      </div>
      <div class="field-item">
        <span class="label">Meses:</span>
        <span class="value">{{ xml.InformacionGlobal.Meses }}</span>
      </div>
      <div class="field-item">
        <span class="label">Año:</span>
        <span class="value">{{ xml.InformacionGlobal['Año'] }}</span>
      </div>
    </div>
  </section>

  <!-- Related Documents -->
  <section class="related-docs" *ngFor="let relGroup of cfdiRelacionados">
    <h3 class="section-title">Documentos Relacionados (Tipo: {{ relGroup.TipoRelacion }})</h3>
    <ul class="uuid-list">
      <li *ngFor="let rel of getRelatedUUIDs(relGroup)">
        {{ rel.UUID }}
      </li>
    </ul>
  </section>

  <!-- Emisor & Receptor -->
  <div class="parties-container">
    <div class="party-card emisor">
      <h3 class="party-title">Emisor</h3>
      <div class="party-content">
        <div class="party-name">{{ xml?.Emisor?.Nombre }}</div>
        <div class="party-rfc">RFC: {{ xml?.Emisor?.Rfc }}</div>
        <div class="field-item" *ngIf="xml?.Emisor?.RegimenFiscal">
          <span class="label">Régimen Fiscal:</span>
          <span class="value">{{ xml.Emisor.RegimenFiscal }}</span>
        </div>
      </div>
    </div>

    <div class="party-card receptor">
      <h3 class="party-title">Receptor</h3>
      <div class="party-content">
        <div class="party-name">{{ xml?.Receptor?.Nombre }}</div>
        <div class="party-rfc">RFC: {{ xml?.Receptor?.Rfc }}</div>
        <div class="field-item" *ngIf="xml?.Receptor?.UsoCFDI">
          <span class="label">Uso CFDI:</span>
          <span class="value">{{ xml.Receptor.UsoCFDI }}</span>
        </div>
        <div class="field-item" *ngIf="xml?.Receptor?.RegimenFiscalReceptor">
          <span class="label">Régimen Fiscal Receptor:</span>
          <span class="value">{{ xml.Receptor.RegimenFiscalReceptor }}</span>
        </div>
        <div class="field-item" *ngIf="xml?.Receptor?.DomicilioFiscalReceptor">
          <span class="label">CP Receptor:</span>
          <span class="value">{{ xml.Receptor.DomicilioFiscalReceptor }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Conceptos -->
  <section class="conceptos-section">
    <h3 class="section-title">Conceptos</h3>
    <table class="conceptos-table">
      <thead>
        <tr>
          <th>Cant.</th>
          <th>Unidad</th>
          <th>Clave P/S</th>
          <th>Descripción</th>
          <th>Valor Unit.</th>
          <th>Importe</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let concepto of conceptos">
          <tr class="main-row">
            <td>{{ concepto.Cantidad }}</td>
            <td>{{ concepto.ClaveUnidad }} <small *ngIf="conceptos.Unidad">({{ conceptos.Unidad }})</small></td>
            <td>{{ concepto.ClaveProdServ }}</td>
            <td>{{ concepto.Descripcion }}</td>
            <td>{{ concepto.ValorUnitario | currency }}</td>
            <td>{{ concepto.Importe | currency }}</td>
          </tr>
          <!-- Sub-details for Concepto -->
          <tr class="details-row">
            <td colspan="6">
              <div class="concept-details">
                <span *ngIf="concepto.NoIdentificacion"><strong>No. Identificación:</strong> {{
                  concepto.NoIdentificacion }} | </span>
                <span *ngIf="concepto.Descuento"><strong>Descuento:</strong> {{ concepto.Descuento | currency }} |
                </span>
                <span *ngIf="concepto.ObjetoImp"><strong>Objeto Impuesto:</strong> {{ concepto.ObjetoImp }}</span>

                <!-- Taxes per concept -->
                <div class="concept-taxes"
                  *ngIf="getImpuestosConcepto(concepto).traslados.length || getImpuestosConcepto(concepto).retenciones.length">
                  <div class="label">Impuestos del concepto:</div>
                  <div class="tax-tag tras" *ngFor="let t of getImpuestosConcepto(concepto).traslados">
                    Traslado: {{ t.Impuesto }} | Base: {{ t.Base | currency }} | {{ t.TipoFactor }}: {{ t.TasaOCuota }}
                    | {{ t.Importe | currency }}
                  </div>
                  <div class="tax-tag ret" *ngFor="let r of getImpuestosConcepto(concepto).retenciones">
                    Retención: {{ r.Impuesto }} | Base: {{ r.Base | currency }} | {{ r.TipoFactor }}: {{ r.TasaOCuota }}
                    | {{ r.Importe | currency }}
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </section>

  <!-- Complemento de Pago (Pagos 2.0) -->
  <section class="pagos-section" *ngIf="xml?.Complemento?.Pagos">
    <h3 class="section-title">Complemento de Recepción de Pagos</h3>
    <div class="pago-item card" *ngFor="let pago of pagos">
      <div class="pago-header">
        <div class="grid-4">
          <div class="field-item"><span class="label">Fecha Pago:</span><span class="value">{{ pago.FechaPago }}</span>
          </div>
          <div class="field-item"><span class="label">Forma Pago:</span><span class="value">{{ pago.FormaDePagoP
              }}</span></div>
          <div class="field-item"><span class="label">Moneda:</span><span class="value">{{ pago.MonedaP }}</span></div>
          <div class="field-item"><span class="label">Monto:</span><span class="value">{{ pago.Monto | currency
              }}</span></div>
        </div>
      </div>

      <!-- Doctos Relacionados in Pago -->
      <div class="doctos-relacionados" *ngIf="getDocsRelacionados(pago).length">
        <div class="sub-title">Documentos Pagados</div>
        <table class="nested-table">
          <thead>
            <tr>
              <th>Id Documento (UUID)</th>
              <th>Parc.</th>
              <th>Imp. Saldo Ant.</th>
              <th>Imp. Pagado</th>
              <th>Imp. Saldo Insoluto</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doc of getDocsRelacionados(pago)">
              <td>{{ doc.IdDocumento }}</td>
              <td>{{ doc.NumParcialidad }}</td>
              <td>{{ doc.ImpSaldoAnt | currency }}</td>
              <td>{{ doc.ImpPagado | currency }}</td>
              <td>{{ doc.ImpSaldoInsoluto | currency }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Totals & Taxes Summary -->
  <footer class="cfdi-footer">
    <div class="summary-container">
      <div class="tax-summary" *ngIf="xml?.Impuestos">
        <div class="summary-title">Resumen de Impuestos</div>
        <div class="field-item" *ngIf="xml.Impuestos.TotalImpuestosTrasladados">
          <span class="label">Total Trasladados:</span>
          <span class="value">{{ xml.Impuestos.TotalImpuestosTrasladados | currency }}</span>
        </div>
        <div class="field-item" *ngIf="xml.Impuestos.TotalImpuestosRetenidos">
          <span class="label">Total Retenidos:</span>
          <span class="value">{{ xml.Impuestos.TotalImpuestosRetenidos | currency }}</span>
        </div>
      </div>

      <div class="totals-summary">
        <div class="field-item">
          <span class="label">Subtotal:</span>
          <span class="value">{{ xml?.SubTotal | currency }}</span>
        </div>
        <div class="field-item" *ngIf="xml?.Descuento">
          <span class="label">Descuento:</span>
          <span class="value">- {{ xml.Descuento | currency }}</span>
        </div>
        <div class="field-item highlight">
          <span class="label">TOTAL:</span>
          <span class="value">{{ xml?.Total | currency }}</span>
        </div>
        <div class="field-item pesos" *ngIf="xml?.TipoCambio && xml?.TipoCambio != 1">
          <span class="label">Total en MXN (T.C. {{ xml.TipoCambio }}):</span>
          <span class="value">{{ totalPesos | currency }}</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Certificación & Stamps -->
  <section class="stamps-section">
    <div class="stamps-grid">
      <div class="qr-container">
        <!-- Assuming we might add QR generation here in the future or keep a placeholder -->
        <small>QR SAT</small>
      </div>
      <div class="stamp-details">
        <div class="field-item small">
          <span class="label">No. Certificado Emisor:</span>
          <span class="value">{{ xml?.NoCertificado }}</span>
        </div>
        <div class="field-item small">
          <span class="label">Folio Fiscal (UUID):</span>
          <span class="value">{{ xml?.Complemento?.TimbreFiscalDigital?.UUID }}</span>
        </div>
        <div class="field-item small">
          <span class="label">Sello Digital del Emisor:</span>
          <div class="stamp-box">{{ xml?.Sello }}</div>
        </div>
        <div class="field-item small">
          <span class="label">Sello del SAT:</span>
          <div class="stamp-box">{{ xml?.Complemento?.TimbreFiscalDigital?.SelloSAT }}</div>
        </div>
        <div class="field-item small" *ngIf="xml?.Complemento?.TimbreFiscalDigital">
          <span class="label">Cadena Original del Complemento de Certificación Digital del SAT:</span>
          <div class="stamp-box">
            ||{{xml['Complemento']['TimbreFiscalDigital']['Version']}}|{{xml['Complemento']['TimbreFiscalDigital']['UUID']}}|{{xml['Complemento']['TimbreFiscalDigital']['FechaTimbrado']}}|{{xml['Complemento']['TimbreFiscalDigital']['RfcProvCertif']}}|{{xml['Sello']}}||
          </div>
        </div>
      </div>
    </div>
  </section>
</div>